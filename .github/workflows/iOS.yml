name: iOS CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        destination: ['platform="iOS Simulator",name="iPhone 16 Pro",OS=latest']

    steps:
      - uses: actions/checkout@v2

      - name: Run Test
        working-directory: MixpanelDemo
        run: |
          set -o pipefail
          xcodebuild \
            -scheme MixpanelDemo \
            -derivedDataPath Build/ \
            -sdk iphonesimulator \
            -destination "${{ matrix.destination }}" \
            -configuration Debug \
            ONLY_ACTIVE_ARCH=NO \
            ENABLE_TESTABILITY=YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES \
            clean build test | xcpretty -c;

      - name: Pod Lint
        run: |
          gem install cocoapods
          pod lib lint --allow-warnings

      - name: Code Coverage Report
        working-directory: MixpanelDemo/build/Logs/Test
        run: |
          xcrun xccov view --report --files-for-target Mixpanel.framework  *.xcresult
          xcrun xccov view --report --only-targets *.xcresult